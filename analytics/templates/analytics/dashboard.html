{% extends 'analytics/base.html' %}

{% block content %}
<div class="filters-section">
    <h2 class="filters-title">üîç Filtros de An√°lise</h2>
    
    <div class="filters-grid">
        <div class="filter-group">
            <label for="id_filial">Escola (ID Filial)</label>
            <select id="id_filial">
                <option value="">Todas as Escolas</option>
                {% for filial in filiais %}
                <option value="{{ filial }}">Escola {{ filial }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="serie_turma">S√©rie e Turma</label>
            <select id="serie_turma">
                <option value="">Todas as S√©ries/Turmas</option>
                {% for st in series_turmas %}
                <option value="{{ st }}">{{ st }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="nome_disciplina">Disciplina</label>
            <select id="nome_disciplina">
                <option value="">Todas as Disciplinas</option>
                {% for disciplina in disciplinas %}
                <option value="{{ disciplina }}">{{ disciplina }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="tipo_nota_aval">Tipo de Nota</label>
            <select id="tipo_nota_aval">
                <option value="">Todos os Tipos</option>
                {% for tipo in tipos_nota %}
                <option value="{{ tipo }}">{{ tipo }}</option>
                {% endfor %}
            </select>
        </div>
        
        <div class="filter-group">
            <label for="status">Status do Aluno</label>
            <select id="status">
                <option value="">Todos os Status</option>
                {% for status in status_options %}
                <option value="{{ status }}">{{ status }}</option>
                {% endfor %}
            </select>
        </div>
    </div>
</div>

<div class="chart-type-section">
    <h2 class="filters-title">üìà Tipo de Gr√°fico</h2>
    
    <div class="chart-type-grid">
        <div class="chart-type-option">
            <input type="radio" id="chart_comparacao_filiais" name="chart_type" value="comparacao_filiais" checked>
            <label for="chart_comparacao_filiais">Compara√ß√£o entre Escolas</label>
        </div>
        
        <div class="chart-type-option">
            <input type="radio" id="chart_media_disciplina" name="chart_type" value="media_por_disciplina">
            <label for="chart_media_disciplina">M√©dia por Disciplina</label>
        </div>
        
        <div class="chart-type-option">
            <input type="radio" id="chart_status" name="chart_type" value="status_alunos">
            <label for="chart_status">Status dos Alunos</label>
        </div>
        
        <div class="chart-type-option">
            <input type="radio" id="chart_tipo_nota" name="chart_type" value="notas_por_tipo">
            <label for="chart_tipo_nota">M√©dia por Tipo de Avalia√ß√£o</label>
        </div>
        
        <div class="chart-type-option">
            <input type="radio" id="chart_alunos_faixa" name="chart_type" value="alunos_por_faixa">
            <label for="chart_alunos_faixa">Alunos por Faixa de Desempenho</label>
        </div>
    </div>
</div>

<div class="buttons-section">
    <button class="btn btn-primary" onclick="loadChartData()">üîÑ Atualizar Gr√°fico</button>
    <button class="btn btn-secondary" onclick="printReport()">üñ®Ô∏è Imprimir Relat√≥rio</button>
    <button class="btn btn-tertiary" onclick="clearFilters()">üóëÔ∏è Limpar Filtros</button>
</div>

<div id="statistics" class="statistics-section" style="display: none; margin-top: 40px;">
    <!-- Estat√≠sticas ser√£o inseridas aqui via JavaScript -->
</div>

<div class="chart-section">
    <h2 class="chart-title" id="chartTitle">Selecione os filtros e clique em "Atualizar Gr√°fico"</h2>
    <canvas id="chartCanvas"></canvas>
</div>

<script>
let currentChart = null;
let currentChartData = null;
let currentStatistics = null;
let currentFilters = null;

// Fun√ß√£o para obter o CSRF token
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

const csrftoken = getCookie('csrftoken');

// Carregar dados do gr√°fico
async function loadChartData() {
    const filters = {
        id_filial: document.getElementById('id_filial').value,
        serie_turma: document.getElementById('serie_turma').value,
        nome_disciplina: document.getElementById('nome_disciplina').value,
        tipo_nota_aval: document.getElementById('tipo_nota_aval').value,
        status: document.getElementById('status').value,
        chart_type: document.querySelector('input[name="chart_type"]:checked').value
    };
    
    // Armazenar filtros atuais
    currentFilters = filters;
    
    // Mostrar loading
    document.getElementById('chartTitle').textContent = 'Carregando dados...';
    
    try {
        const response = await fetch('/api/chart-data/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrftoken
            },
            body: JSON.stringify(filters)
        });
        
        const data = await response.json();
        
        if (data.success) {
            // Armazenar dados para impress√£o
            currentChartData = data.chart_data;
            currentStatistics = data.statistics;
            
            // Atualizar estat√≠sticas
            updateStatistics(data.statistics);
            
            // Atualizar gr√°fico
            updateChart(data.chart_data);
        } else {
            alert('Erro ao carregar dados: ' + data.error);
        }
    } catch (error) {
        console.error('Erro:', error);
        alert('Erro ao conectar com o servidor');
    }
}

// Atualizar estat√≠sticas
function updateStatistics(stats) {
    const statsSection = document.getElementById('statistics');
    statsSection.style.display = 'grid';
    
    statsSection.innerHTML = `
        <div class="stat-card">
            <h3>Total de Registros</h3>
            <p>${stats.total_registros.toLocaleString('pt-BR')}</p>
        </div>
        <div class="stat-card">
            <h3>Total de Alunos</h3>
            <p>${stats.total_alunos.toLocaleString('pt-BR')}</p>
        </div>
        <div class="stat-card">
            <h3>M√©dia Geral</h3>
            <p>${stats.media_geral.toFixed(2)}</p>
        </div>
        <div class="stat-card">
            <h3>Nota M√°xima</h3>
            <p>${stats.nota_maxima.toFixed(2)}</p>
        </div>
        <div class="stat-card">
            <h3>Nota M√≠nima</h3>
            <p>${stats.nota_minima.toFixed(2)}</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%);">
            <h3>Aprovados</h3>
            <p>${stats.aprovados.toLocaleString('pt-BR')}</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
            <h3>Recupera√ß√£o</h3>
            <p>${stats.recuperacao.toLocaleString('pt-BR')}</p>
        </div>
        <div class="stat-card" style="background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);">
            <h3>Reprovados</h3>
            <p>${stats.reprovados.toLocaleString('pt-BR')}</p>
        </div>
    `;
}

// Atualizar gr√°fico
function updateChart(chartData) {
    const ctx = document.getElementById('chartCanvas').getContext('2d');
    
    // Destruir gr√°fico anterior se existir
    if (currentChart) {
        currentChart.destroy();
    }
    
    // Atualizar t√≠tulo
    document.getElementById('chartTitle').textContent = chartData.title;
    
    // Determinar tipo de gr√°fico
    const chartType = document.querySelector('input[name="chart_type"]:checked').value;
    let chartTypeDisplay = 'bar';
    
    if (chartType === 'status_alunos' || chartType === 'alunos_por_faixa') {
        chartTypeDisplay = 'pie';
    }
    
    // Preparar datasets
    let datasets;
    if (chartData.type === 'grouped' && chartData.datasets) {
        // Gr√°fico agrupado (m√∫ltiplos datasets)
        datasets = chartData.datasets.map(ds => ({
            label: ds.label,
            data: ds.data,
            backgroundColor: ds.color,
            borderColor: ds.color.replace('0.7', '1'),
            borderWidth: 2
        }));
    } else {
        // Gr√°fico simples (um dataset)
        datasets = [{
            label: chartData.title,
            data: chartData.data,
            backgroundColor: [
                'rgba(102, 126, 234, 0.7)',
                'rgba(118, 75, 162, 0.7)',
                'rgba(40, 167, 69, 0.7)',
                'rgba(255, 193, 7, 0.7)',
                'rgba(220, 53, 69, 0.7)',
                'rgba(23, 162, 184, 0.7)',
                'rgba(108, 117, 125, 0.7)',
                'rgba(255, 152, 0, 0.7)'
            ],
            borderColor: [
                'rgba(102, 126, 234, 1)',
                'rgba(118, 75, 162, 1)',
                'rgba(40, 167, 69, 1)',
                'rgba(255, 193, 7, 1)',
                'rgba(220, 53, 69, 1)',
                'rgba(23, 162, 184, 1)',
                'rgba(108, 117, 125, 1)',
                'rgba(255, 152, 0, 1)'
            ],
            borderWidth: 2
        }];
    }
    
    // Criar novo gr√°fico
    currentChart = new Chart(ctx, {
        type: chartTypeDisplay,
        data: {
            labels: chartData.labels,
            datasets: datasets
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: chartTypeDisplay === 'pie' || (chartData.type === 'grouped'),
                    position: 'bottom'
                },
                tooltip: {
                    enabled: true,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    padding: 12,
                    titleFont: { size: 14 },
                    bodyFont: { size: 13 }
                }
            },
            scales: chartTypeDisplay === 'bar' ? {
                y: {
                    beginAtZero: true,
                    ticks: {
                        font: { size: 12 }
                    }
                },
                x: {
                    ticks: {
                        font: { size: 12 }
                    }
                }
            } : {}
        }
    });
}

// Imprimir relat√≥rio
function printReport() {
    if (!currentChartData || !currentStatistics) {
        alert('Por favor, gere um gr√°fico primeiro antes de imprimir!');
        return;
    }
    
    // Criar conte√∫do do relat√≥rio
    let reportContent = `
        <!DOCTYPE html>
        <html lang="pt-BR">
        <head>
            <meta charset="UTF-8">
            <title>Relat√≥rio de An√°lise de Notas</title>
            <style>
                body {
                    font-family: Arial, sans-serif;
                    padding: 40px;
                    max-width: 900px;
                    margin: 0 auto;
                }
                h1 {
                    color: #667eea;
                    border-bottom: 3px solid #667eea;
                    padding-bottom: 10px;
                }
                h2 {
                    color: #764ba2;
                    margin-top: 30px;
                    border-bottom: 2px solid #e0e0e0;
                    padding-bottom: 8px;
                }
                .info-section {
                    background: #f8f9fa;
                    padding: 15px;
                    border-radius: 8px;
                    margin: 20px 0;
                }
                .info-item {
                    margin: 8px 0;
                    font-size: 14px;
                }
                .info-label {
                    font-weight: bold;
                    color: #555;
                }
                table {
                    width: 100%;
                    border-collapse: collapse;
                    margin: 20px 0;
                }
                th {
                    background: #667eea;
                    color: white;
                    padding: 12px;
                    text-align: left;
                    font-weight: 600;
                }
                td {
                    padding: 10px 12px;
                    border-bottom: 1px solid #e0e0e0;
                }
                tr:hover {
                    background: #f8f9fa;
                }
                .stats-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 15px;
                    margin: 20px 0;
                }
                .stat-card {
                    background: #667eea;
                    color: white;
                    padding: 15px;
                    border-radius: 8px;
                    text-align: center;
                }
                .stat-card.green { background: #28a745; }
                .stat-card.yellow { background: #ffc107; color: #333; }
                .stat-card.red { background: #dc3545; }
                .stat-label {
                    font-size: 12px;
                    text-transform: uppercase;
                    opacity: 0.9;
                    margin-bottom: 5px;
                }
                .stat-value {
                    font-size: 24px;
                    font-weight: bold;
                }
                .footer {
                    margin-top: 40px;
                    padding-top: 20px;
                    border-top: 2px solid #e0e0e0;
                    text-align: center;
                    color: #999;
                    font-size: 12px;
                }
                @media print {
                    body { padding: 20px; }
                }
            </style>
        </head>
        <body>
            <h1>üìä Relat√≥rio de An√°lise de Notas</h1>
            <p style="color: #666;">Sistema Big Data Analytics - Notas Escolares</p>
            
            <div class="info-section">
                <h2>Filtros Aplicados</h2>
                <div class="info-item"><span class="info-label">Escola:</span> ${currentFilters.id_filial || 'Todas'}</div>
                <div class="info-item"><span class="info-label">S√©rie/Turma:</span> ${currentFilters.serie_turma || 'Todas'}</div>
                <div class="info-item"><span class="info-label">Disciplina:</span> ${currentFilters.nome_disciplina || 'Todas'}</div>
                <div class="info-item"><span class="info-label">Tipo de Nota:</span> ${currentFilters.tipo_nota_aval || 'Todos'}</div>
                <div class="info-item"><span class="info-label">Status:</span> ${currentFilters.status || 'Todos'}</div>
                <div class="info-item"><span class="info-label">Data:</span> ${new Date().toLocaleString('pt-BR')}</div>
            </div>
            
            <h2>Estat√≠sticas Gerais</h2>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Total de Registros</div>
                    <div class="stat-value">${currentStatistics.total_registros.toLocaleString('pt-BR')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total de Alunos</div>
                    <div class="stat-value">${currentStatistics.total_alunos.toLocaleString('pt-BR')}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">M√©dia Geral</div>
                    <div class="stat-value">${currentStatistics.media_geral.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nota M√°xima</div>
                    <div class="stat-value">${currentStatistics.nota_maxima.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Nota M√≠nima</div>
                    <div class="stat-value">${currentStatistics.nota_minima.toFixed(2)}</div>
                </div>
                <div class="stat-card green">
                    <div class="stat-label">Aprovados</div>
                    <div class="stat-value">${currentStatistics.aprovados.toLocaleString('pt-BR')}</div>
                </div>
                <div class="stat-card yellow">
                    <div class="stat-label">Recupera√ß√£o</div>
                    <div class="stat-value">${currentStatistics.recuperacao.toLocaleString('pt-BR')}</div>
                </div>
                <div class="stat-card red">
                    <div class="stat-label">Reprovados</div>
                    <div class="stat-value">${currentStatistics.reprovados.toLocaleString('pt-BR')}</div>
                </div>
            </div>
            
            <h2>${currentChartData.title}</h2>
            <table>
                <thead>
                    <tr>
                        <th>Item</th>
    `;
    
    // Se for gr√°fico agrupado, adicionar colunas para cada dataset
    if (currentChartData.type === 'grouped' && currentChartData.datasets) {
        for (let ds of currentChartData.datasets) {
            reportContent += `<th style="text-align: right;">${ds.label}</th>`;
        }
    } else {
        reportContent += `<th style="text-align: right;">Valor</th>`;
    }
    
    reportContent += `
                    </tr>
                </thead>
                <tbody>
    `;
    
    // Adicionar dados do gr√°fico na tabela
    for (let i = 0; i < currentChartData.labels.length; i++) {
        reportContent += `<tr><td>${currentChartData.labels[i]}</td>`;
        
        if (currentChartData.type === 'grouped' && currentChartData.datasets) {
            // Gr√°fico agrupado: mostrar dados de cada dataset
            for (let ds of currentChartData.datasets) {
                reportContent += `<td style="text-align: right; font-weight: 600;">${ds.data[i].toLocaleString('pt-BR')}</td>`;
            }
        } else {
            // Gr√°fico simples: mostrar apenas um valor
            reportContent += `<td style="text-align: right; font-weight: 600;">${currentChartData.data[i].toLocaleString('pt-BR')}</td>`;
        }
        
        reportContent += `</tr>`;
    }
    
    reportContent += `
                </tbody>
            </table>
            
            <div class="footer">
                <p>Big Data Analytics - Sistema de An√°lise de Notas Escolares</p>
                <p>Relat√≥rio gerado em ${new Date().toLocaleString('pt-BR')}</p>
            </div>
        </body>
        </html>
    `;
    
    // Abrir nova janela e imprimir
    const printWindow = window.open('', '', 'width=900,height=700');
    printWindow.document.write(reportContent);
    printWindow.document.close();
    printWindow.focus();
    
    // Aguardar carregamento e imprimir
    setTimeout(() => {
        printWindow.print();
    }, 250);
}

// Limpar filtros
function clearFilters() {
    document.getElementById('id_filial').value = '';
    document.getElementById('serie_turma').value = '';
    document.getElementById('nome_disciplina').value = '';
    document.getElementById('tipo_nota_aval').value = '';
    document.getElementById('status').value = '';
    document.querySelector('input[value="comparacao_filiais"]').checked = true;
    
    // Limpar estat√≠sticas e gr√°fico
    document.getElementById('statistics').style.display = 'none';
    document.getElementById('chartTitle').textContent = 'Selecione os filtros e clique em "Atualizar Gr√°fico"';
    
    if (currentChart) {
        currentChart.destroy();
        currentChart = null;
    }
}

// Carregar dados iniciais ao carregar a p√°gina
window.addEventListener('load', function() {
    loadChartData();
});
</script>
{% endblock %}

